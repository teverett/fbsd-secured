- name: install node_exporter
  ansible.builtin.command: pkg install -y node_exporter

- name: enable node_exporter
  ansible.builtin.lineinfile:
    path: /etc/rc.conf
    line: node_exporter_enable=YES
    regex: ^node_exporter_enable

- name: start node_exporter
  ansible.builtin.service:
    name: node_exporter
    state: started
    enabled: true

- name: enable node_exporter traffic in pf
  ansible.builtin.lineinfile:
    path: /etc/pf.conf
    line: 'pass in proto tcp to port { 9100 }'
    insertafter: '# -- incremental pass rules --'

- name: enable node_exporter traffic in pf (comment)
  ansible.builtin.lineinfile:
    path: /etc/pf.conf
    line: '# enable node_exporter'
    insertafter: '# -- incremental pass rules --'

- name: add blank line
  ansible.builtin.lineinfile:
    path: /etc/pf.conf
    line: ' '
    insertafter: '# -- incremental pass rules --'

# don't restart the pf service: that disconnects ssh
- name: restart pf
  ansible.builtin.shell:
    cmd: pfctl -f /etc/pf.conf

